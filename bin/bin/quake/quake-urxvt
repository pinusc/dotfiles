#!/usr/bin/env bash

IFS='' read -r -d '' helpstring <<EOF
quake-rxvt: manage quaked windows
USAGE: quake-rxvt [-e exec_command wmname] [wmname create_command]

Args:
    wmname              The X wmname of the window to manage
    create_command      The command to run to create a window with class wmname, taking a WIDFILE as \$1
    -e exec_command     If supplied, a TERM window executing exec_command will be created

Defaults to creating urxvt windows.

EOF
msg() {
  echo >&2 -e "${1-}"
}

die() {
  local msg=$1
  local code=${2-1} # default exit status 1
  msg "$msg"
  exit "$code"
}

usage() {
    echo "$helpstring"
    exit 0
}


parse_params() {
  # default values of variables set from params
  exec_command=""
  create_command=""

  while :; do
    case "${1-}" in
    -h | --help) usage ;;
    -v | --verbose) set -x ;;
    -e)
      exec_command="${2-}"
      shift
      ;;
    -?*) die "Unknown option: $1" ;;
    *) break ;;
    esac
    shift
  done

  args=("$@")

  # check required params and arguments
  [[ ${#args[@]} -gt 2 ]] && die "Incorrect arguments passed. Try --help"

  if [[ "${#args[@]}" -gt 0 ]]; then
      wmname="${args[0]}"
      if [[ "${#args[@]}" -eq 2 ]]; then
          create_command="${args[1]}"
      fi
  fi
  if [[ -n "$wmname" && -z "$exec_command" && -z "$create_command" ]]; then
      die "Incorrect arguments passed. Try --help"
  fi

  return 0
}

parse_params "$@"

[[ -z "$wmname" ]] && wmname="quake-tab"
[[ -z "$create_command" ]] && create_command="quake-urxvt-newtab"
WIDFILE="/tmp/quake-tabbed-$wmname.wid"
echo "$WIDFILE"
wid=$(xdotool search --classname "$wmname")

GEOMETRY=1366x768

if [[ -z "$wid" ]]; then
    wid=$(tabbed -n "$wmname" -d -g "$GEOMETRY" )
    echo "$wid" > "$WIDFILE"
    if [[ -n "$exec_command" ]]; then
        "$create_command" "$WIDFILE" "$exec_command"
    else
        "$create_command" "$WIDFILE"
    fi
    exit 0
fi

state="$(xprop -id "$wid" | awk -F: '/window state/{print $2;}' \
    | tr -d ' ' | tr '[:upper:]' '[:lower:]')" 

echo $state

if [ "$state" = "normal" ]; then
    xdotool search --classname "$wmname" windowunmap
elif [ "$state" = iconic ]; then
    bspc node "$wid" -d focused
else
    xdotool search --classname "$wmname" windowmap
fi
